<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex, nofollow" />
    <link rel="shortcut icon" href="admin-assets/images/favicon.svg" type="image/x-icon" />
    <title>Qu·∫£n L√Ω Menu | TikTok Menu Admin</title>

    <!-- PlainAdmin CSS -->
    <link rel="stylesheet" href="admin-assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="admin-assets/css/lineicons.css" />
    <link rel="stylesheet" href="admin-assets/css/materialdesignicons.min.css" />
    <link rel="stylesheet" href="admin-assets/css/main.css" />
  </head>
  <body>
    <!-- ======== Preloader =========== -->
    <div id="preloader">
      <div class="spinner"></div>
    </div>

    <!-- ======== sidebar-nav start =========== -->
    <aside class="sidebar-nav-wrapper">
      <div class="navbar-logo">
        <a href="index.html">
          <img src="admin-assets/images/logo/logo.svg" alt="logo" />
        </a>
      </div>
      <nav class="sidebar-nav">
        <ul>
          <li class="nav-item nav-item-has-children">
            <a href="#0" data-bs-toggle="collapse" data-bs-target="#ddmenu_1" aria-controls="ddmenu_1" aria-expanded="true" aria-label="Toggle navigation">
              <span class="icon">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M8.74999 18.3333C12.2376 18.3333 15.1364 15.8128 15.7244 12.4941C15.8448 11.8143 15.2737 11.25 14.5833 11.25H9.99999C9.30966 11.25 8.74999 10.6903 8.74999 10V5.41666C8.74999 4.7263 8.18563 4.15512 7.50586 4.27556C4.18711 4.86357 1.66666 7.76243 1.66666 11.25C1.66666 15.162 4.83797 18.3333 8.74999 18.3333Z" />
                  <path d="M17.0833 10C17.7737 10 18.3432 9.43708 18.2408 8.75433C17.7005 5.14918 14.8508 2.29947 11.2457 1.75912C10.5629 1.6568 10 2.2263 10 2.91665V9.16666C10 9.62691 10.3731 10 10.8333 10H17.0833Z" />
                </svg>
              </span>
              <span class="text">Dashboard</span>
            </a>
            <ul id="ddmenu_1" class="collapse show dropdown-nav">
              <li><a href="admin.html">Qu·∫£n l√Ω ƒë∆°n h√†ng</a></li>
              <li><a href="admin-services.html" class="active">Qu·∫£n l√Ω menu</a></li>
            </ul>
          </li>
          <span class="divider"><hr /></span>
          <li class="nav-item">
            <a href="#" id="logoutBtn">
              <span class="icon"><i class="lni lni-exit"></i></span>
              <span class="text">ƒêƒÉng xu·∫•t</span>
            </a>
          </li>
        </ul>
      </nav>
    </aside>
    <div class="overlay"></div>
    <!-- ======== sidebar-nav end =========== -->

    <!-- ======== main-wrapper start =========== -->
    <main class="main-wrapper">
      <!-- ========== header start ========== -->
      <header class="header">
        <div class="container-fluid">
          <div class="row">
            <div class="col-lg-5 col-md-5 col-6">
              <div class="header-left d-flex align-items-center">
                <div class="menu-toggle-btn mr-15">
                  <button id="menu-toggle" class="main-btn primary-btn btn-hover">
                    <i class="lni lni-chevron-left me-2"></i> Menu
                  </button>
                </div>
              </div>
            </div>
            <div class="col-lg-7 col-md-7 col-6">
              <div class="header-right">
                <div class="profile-box ml-15">
                  <div class="profile-info">
                    <div class="info">
                      <h6 class="fw-500">Admin</h6>
                      <p>Qu·∫£n tr·ªã vi√™n</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </header>
      <!-- ========== header end ========== -->

      <!-- ========== section start ========== -->
      <section class="section">
        <div class="container-fluid">
          <!-- ========== title-wrapper start ========== -->
          <div class="title-wrapper pt-30">
            <div class="row align-items-center">
              <div class="col-md-6">
                <div class="title">
                  <h2>Qu·∫£n L√Ω Menu Livestream</h2>
                </div>
              </div>
              <div class="col-md-6">
                <div class="breadcrumb-wrapper">
                  <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                      <li class="breadcrumb-item"><a href="#">Dashboard</a></li>
                      <li class="breadcrumb-item active" aria-current="page">Menu</li>
                    </ol>
                  </nav>
                </div>
              </div>
            </div>
          </div>
          <!-- ========== title-wrapper end ========== -->

          <!-- Add Service Button -->
          <div class="row mb-3">
            <div class="col-12">
              <button class="main-btn primary-btn btn-hover" id="addServiceBtn">
                <i class="lni lni-plus me-2"></i> Th√™m D·ªãch V·ª•
              </button>
              <p class="text-muted mt-2"><small>üìå ƒê√¢y l√† menu hi·ªÉn th·ªã khi livestream, kh√¥ng ph·∫£i lo·∫°i d·ªãch v·ª• Free/Combo trong form ƒë·∫∑t h√†ng</small></p>
            </div>
          </div>

          <!-- Services Table -->
          <div class="row">
            <div class="col-lg-12">
              <div class="card-style mb-30">
                <div class="title d-flex flex-wrap justify-content-between align-items-center">
                  <div class="left">
                    <h6 class="text-medium mb-30">Danh S√°ch Menu</h6>
                  </div>
                </div>
                
                <div class="table-wrapper table-responsive">
                  <table class="table">
                    <thead>
                      <tr>
                        <th><h6 class="text-sm text-medium">STT</h6></th>
                        <th><h6 class="text-sm text-medium">Icon</h6></th>
                        <th><h6 class="text-sm text-medium">T√™n d·ªãch v·ª•</h6></th>
                        <th><h6 class="text-sm text-medium">SL</h6></th>
                        <th><h6 class="text-sm text-medium">Badges</h6></th>
                        <th><h6 class="text-sm text-medium">HOT</h6></th>
                        <th><h6 class="text-sm text-medium">Tr·∫°ng th√°i</h6></th>
                        <th><h6 class="text-sm text-medium">Thao t√°c</h6></th>
                      </tr>
                    </thead>
                    <tbody id="servicesTableBody">
                      <tr>
                        <td colspan="8" class="text-center py-5">ƒêang t·∫£i...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

        </div>
      </section>
      <!-- ========== section end ========== -->

      <!-- ========== footer start =========== -->
      <footer class="footer">
        <div class="container-fluid">
          <div class="row">
            <div class="col-md-6 order-last order-md-first">
              <div class="copyright text-center text-md-start">
                <p class="text-sm">¬© 2024-2025 TikTok Menu Admin</p>
              </div>
            </div>
          </div>
        </div>
      </footer>
      <!-- ========== footer end =========== -->
    </main>
    <!-- ======== main-wrapper end =========== -->

    <!-- Service Modal -->
    <div class="modal fade" id="serviceModal" tabindex="-1" aria-labelledby="serviceModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="serviceModalLabel">Th√™m D·ªãch V·ª•</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="serviceForm">
              <input type="hidden" id="serviceId" />
              <div class="row">
                <div class="col-md-8">
                  <div class="input-style-1">
                    <label>T√™n d·ªãch v·ª• *</label>
                    <input type="text" id="serviceName" placeholder="VD: 10.000 View (Nhanh)" required />
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="input-style-1">
                    <label>S·ªë l∆∞·ª£ng</label>
                    <input type="number" id="serviceQty" value="1" min="1" />
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-8">
                  <div class="input-style-1">
                    <label>Icon URL (TikTok Gift)</label>
                    <input type="text" id="serviceIcon" placeholder="https://p16-webcast.tiktokcdn.com/..." />
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="input-style-1">
                    <label>Badges (emoji)</label>
                    <input type="text" id="serviceBadges" placeholder="‚ù§Ô∏èüáªüá≥üá∫üá∏" />
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-4">
                  <div class="input-style-1">
                    <label>Th·ª© t·ª± s·∫Øp x·∫øp</label>
                    <input type="number" id="serviceSortOrder" value="0" min="0" />
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-check checkbox-style mt-4">
                    <input class="form-check-input" type="checkbox" id="serviceIsHot" />
                    <label class="form-check-label" for="serviceIsHot">üî• HOT Badge</label>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-12">
                  <div class="input-style-1">
                    <label>M√¥ t·∫£ / Th√¥ng tin</label>
                    <input type="text" id="serviceDescription" placeholder="VD: Kh√¥ng t·ª•t, b·∫£o h√†nh 365 ng√†y" />
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="main-btn light-btn btn-hover" data-bs-dismiss="modal">H·ªßy</button>
            <button type="button" class="main-btn primary-btn btn-hover" id="saveServiceBtn">L∆∞u</button>
          </div>
        </div>
      </div>
    </div>

    <!-- PlainAdmin JS -->
    <script src="admin-assets/js/bootstrap.bundle.min.js"></script>
    <script src="admin-assets/js/main.js"></script>

    <!-- Services Management Logic -->
    <script>
      // Check auth
      if (!localStorage.getItem('adminToken')) {
        window.location.href = 'admin-login.html';
      }

      // State
      let allServices = [];
      let editingId = null;

      // DOM Elements
      const logoutBtn = document.getElementById('logoutBtn');
      const servicesTableBody = document.getElementById('servicesTableBody');
      const addServiceBtn = document.getElementById('addServiceBtn');
      const saveServiceBtn = document.getElementById('saveServiceBtn');
      const serviceModal = new bootstrap.Modal(document.getElementById('serviceModal'));

      // Logout
      logoutBtn.addEventListener('click', (e) => {
        e.preventDefault();
        localStorage.removeItem('adminToken');
        window.location.href = 'admin-login.html';
      });

      // Add service button
      addServiceBtn.addEventListener('click', () => {
        editingId = null;
        document.getElementById('serviceModalLabel').textContent = 'Th√™m D·ªãch V·ª•';
        document.getElementById('serviceForm').reset();
        serviceModal.show();
      });

      // Save service
      saveServiceBtn.addEventListener('click', async () => {
        const name = document.getElementById('serviceName').value;

        if (!name) {
          alert('‚ùå Vui l√≤ng nh·∫≠p t√™n d·ªãch v·ª•!');
          return;
        }

        const serviceData = {
          name,
          icon_url: document.getElementById('serviceIcon').value || null,
          badges: document.getElementById('serviceBadges').value || null,
          is_hot: document.getElementById('serviceIsHot').checked,
          qty: parseInt(document.getElementById('serviceQty').value) || 1,
          description: document.getElementById('serviceDescription').value || null,
          sort_order: parseInt(document.getElementById('serviceSortOrder').value) || 0
        };

        try {
          const token = localStorage.getItem('adminToken');
          let response;

          if (editingId) {
            serviceData.id = editingId;
            response = await fetch('/.netlify/functions/services', {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify(serviceData)
            });
          } else {
            response = await fetch('/.netlify/functions/services', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify(serviceData)
            });
          }

          if (response.ok) {
            serviceModal.hide();
            loadServices();
            alert('‚úÖ L∆∞u d·ªãch v·ª• th√†nh c√¥ng!');
          } else {
            const error = await response.json();
            alert('‚ùå L·ªói: ' + (error.error || 'Kh√¥ng th·ªÉ l∆∞u'));
          }
        } catch (error) {
          console.error('Error saving service:', error);
          alert('‚ùå C√≥ l·ªói x·∫£y ra!');
        }
      });

      // Load services
      async function loadServices() {
        try {
          const response = await fetch('/.netlify/functions/services');
          allServices = await response.json();
          renderServices();
        } catch (error) {
          console.error('Error loading services:', error);
          servicesTableBody.innerHTML = `
            <tr>
              <td colspan="8" class="text-center py-5 text-danger">
                ‚ùå Kh√¥ng th·ªÉ t·∫£i d·ªãch v·ª•
              </td>
            </tr>
          `;
        }
      }

      // Render services table
      function renderServices() {
        if (allServices.length === 0) {
          servicesTableBody.innerHTML = `
            <tr>
              <td colspan="8" class="text-center py-5">üì≠ Ch∆∞a c√≥ d·ªãch v·ª• n√†o. Nh·∫•n "Th√™m D·ªãch V·ª•" ƒë·ªÉ b·∫Øt ƒë·∫ßu!</td>
            </tr>
          `;
          return;
        }

        servicesTableBody.innerHTML = allServices.map((service, index) => `
          <tr>
            <td><p class="text-sm">${index + 1}</p></td>
            <td>
              ${service.icon_url ? `<img src="${service.icon_url}" alt="" style="width: 32px; height: 32px; object-fit: contain;" />` : 'üì¶'}
            </td>
            <td>
              <p class="text-sm"><strong>${service.name}</strong></p>
              ${service.description ? `<small class="text-muted">${service.description}</small>` : ''}
            </td>
            <td><p class="text-sm">${service.qty || 1}</p></td>
            <td><p class="text-sm">${service.badges || '-'}</p></td>
            <td>${service.is_hot ? 'üî• HOT' : '-'}</td>
            <td>
              <span class="badge bg-${service.is_active ? 'success' : 'secondary'}">
                ${service.is_active ? 'Hi·ªán' : '·∫®n'}
              </span>
            </td>
            <td>
              <button class="btn btn-sm btn-outline-primary me-1" onclick="editService(${service.id})">
                <i class="lni lni-pencil"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteService(${service.id})">
                <i class="lni lni-trash-can"></i>
              </button>
            </td>
          </tr>
        `).join('');
      }

      // Edit service
      window.editService = function(id) {
        const service = allServices.find(s => s.id === id);
        if (!service) return;

        editingId = id;
        document.getElementById('serviceModalLabel').textContent = 'S·ª≠a D·ªãch V·ª•';
        document.getElementById('serviceId').value = id;
        document.getElementById('serviceName').value = service.name;
        document.getElementById('serviceIcon').value = service.icon_url || '';
        document.getElementById('serviceBadges').value = service.badges || '';
        document.getElementById('serviceIsHot').checked = service.is_hot;
        document.getElementById('serviceQty').value = service.qty || 1;
        document.getElementById('serviceSortOrder').value = service.sort_order || 0;
        document.getElementById('serviceDescription').value = service.description || '';

        serviceModal.show();
      };

      // Delete service
      window.deleteService = async function(id) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a d·ªãch v·ª• n√†y?')) return;

        try {
          const token = localStorage.getItem('adminToken');
          const response = await fetch('/.netlify/functions/services', {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ id })
          });

          if (response.ok) {
            loadServices();
            alert('‚úÖ ƒê√£ x√≥a d·ªãch v·ª•!');
          } else {
            alert('‚ùå Kh√¥ng th·ªÉ x√≥a!');
          }
        } catch (error) {
          console.error('Error deleting service:', error);
          alert('‚ùå C√≥ l·ªói x·∫£y ra!');
        }
      };

      // Load on page start
      loadServices();
    </script>
  </body>
</html>
