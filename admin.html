<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex, nofollow" />
    <link rel="shortcut icon" href="admin-assets/images/favicon.svg" type="image/x-icon" />
    <title>Dashboard | TikTok Menu Admin</title>

    <!-- PlainAdmin CSS -->
    <link rel="stylesheet" href="admin-assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="admin-assets/css/lineicons.css" />
    <link rel="stylesheet" href="admin-assets/css/materialdesignicons.min.css" />
    <link rel="stylesheet" href="admin-assets/css/main.css" />
  </head>
  <body>
    <!-- ======== Preloader =========== -->
    <div id="preloader">
      <div class="spinner"></div>
    </div>

    <!-- ======== sidebar-nav start =========== -->
    <aside class="sidebar-nav-wrapper">
      <div class="navbar-logo">
        <a href="index.html">
          <img src="admin-assets/images/logo/logo.svg" alt="logo" />
        </a>
      </div>
      <nav class="sidebar-nav">
        <ul>
          <li class="nav-item nav-item-has-children">
            <a href="#0" data-bs-toggle="collapse" data-bs-target="#ddmenu_1" aria-controls="ddmenu_1" aria-expanded="true" aria-label="Toggle navigation">
              <span class="icon">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M8.74999 18.3333C12.2376 18.3333 15.1364 15.8128 15.7244 12.4941C15.8448 11.8143 15.2737 11.25 14.5833 11.25H9.99999C9.30966 11.25 8.74999 10.6903 8.74999 10V5.41666C8.74999 4.7263 8.18563 4.15512 7.50586 4.27556C4.18711 4.86357 1.66666 7.76243 1.66666 11.25C1.66666 15.162 4.83797 18.3333 8.74999 18.3333Z" />
                  <path d="M17.0833 10C17.7737 10 18.3432 9.43708 18.2408 8.75433C17.7005 5.14918 14.8508 2.29947 11.2457 1.75912C10.5629 1.6568 10 2.2263 10 2.91665V9.16666C10 9.62691 10.3731 10 10.8333 10H17.0833Z" />
                </svg>
              </span>
              <span class="text">Dashboard</span>
            </a>
            <ul id="ddmenu_1" class="collapse show dropdown-nav">
              <li><a href="admin.html" class="active">Qu·∫£n l√Ω ƒë∆°n h√†ng</a></li>
              <li><a href="admin-services.html">Qu·∫£n l√Ω menu</a></li>
              <li><a href="admin-categories.html">Qu·∫£n l√Ω lo·∫°i d·ªãch v·ª•</a></li>
            </ul>
          </li>
          <span class="divider"><hr /></span>
          <li class="nav-item">
            <a href="#" id="logoutBtn">
              <span class="icon"><i class="lni lni-exit"></i></span>
              <span class="text">ƒêƒÉng xu·∫•t</span>
            </a>
          </li>
        </ul>
      </nav>
    </aside>
    <div class="overlay"></div>
    <!-- ======== sidebar-nav end =========== -->

    <!-- ======== main-wrapper start =========== -->
    <main class="main-wrapper">
      <!-- ========== header start ========== -->
      <header class="header">
        <div class="container-fluid">
          <div class="row">
            <div class="col-lg-5 col-md-5 col-6">
              <div class="header-left d-flex align-items-center">
                <div class="menu-toggle-btn mr-15">
                  <button id="menu-toggle" class="main-btn primary-btn btn-hover">
                    <i class="lni lni-chevron-left me-2"></i> Menu
                  </button>
                </div>
                <div class="header-search d-none d-md-flex">
                  <form action="#">
                    <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm ƒë∆°n h√†ng..." />
                    <button type="button"><i class="lni lni-search-alt"></i></button>
                  </form>
                </div>
              </div>
            </div>
            <div class="col-lg-7 col-md-7 col-6">
              <div class="header-right">
                <!-- profile start -->
                <div class="profile-box ml-15">
                  <button class="dropdown-toggle bg-transparent border-0" type="button" id="profile" data-bs-toggle="dropdown" aria-expanded="false">
                    <div class="profile-info">
                      <div class="info">
                        <div class="image">
                          <img src="admin-assets/images/profile/profile-image.png" alt="" />
                        </div>
                        <div>
                          <h6 class="fw-500">Admin</h6>
                          <p>Qu·∫£n tr·ªã vi√™n</p>
                        </div>
                      </div>
                    </div>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profile">
                    <li>
                      <div class="author-info flex items-center !p-1">
                        <div class="image">
                          <img src="admin-assets/images/profile/profile-image.png" alt="image">
                        </div>
                        <div class="content">
                          <h4 class="text-sm">Admin</h4>
                          <a class="text-black/40 dark:text-white/40 hover:text-black dark:hover:text-white text-xs" href="#">admin@tiktok-menu.com</a>
                        </div>
                      </div>
                    </li>
                    <li class="divider"></li>
                    <li><a href="#" id="logoutBtn2"><i class="lni lni-exit"></i> ƒêƒÉng xu·∫•t</a></li>
                  </ul>
                </div>
                <!-- profile end -->
              </div>
            </div>
          </div>
        </div>
      </header>
      <!-- ========== header end ========== -->

      <!-- ========== section start ========== -->
      <section class="section">
        <div class="container-fluid">
          <!-- ========== title-wrapper start ========== -->
          <div class="title-wrapper pt-30">
            <div class="row align-items-center">
              <div class="col-md-6">
                <div class="title">
                  <h2>Qu·∫£n L√Ω ƒê∆°n H√†ng</h2>
                </div>
              </div>
              <div class="col-md-6">
                <div class="breadcrumb-wrapper">
                  <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                      <li class="breadcrumb-item"><a href="#">Dashboard</a></li>
                      <li class="breadcrumb-item active" aria-current="page">ƒê∆°n h√†ng</li>
                    </ol>
                  </nav>
                </div>
              </div>
            </div>
          </div>
          <!-- ========== title-wrapper end ========== -->

          <!-- ========== Stats Cards ========== -->
          <div class="row">
            <div class="col-xl-2 col-lg-4 col-sm-6">
              <div class="icon-card mb-30">
                <div class="icon purple">
                  <i class="lni lni-cart-full"></i>
                </div>
                <div class="content">
                  <h6 class="mb-10">T·ªïng ƒë∆°n</h6>
                  <h3 class="text-bold mb-10" id="totalStat">0</h3>
                  <p class="text-sm text-success">
                    <i class="lni lni-arrow-up"></i> T·∫•t c·∫£
                  </p>
                </div>
              </div>
            </div>
            <div class="col-xl-2 col-lg-4 col-sm-6">
              <div class="icon-card mb-30">
                <div class="icon orange">
                  <i class="lni lni-timer"></i>
                </div>
                <div class="content">
                  <h6 class="mb-10">Ch·ªù x·ª≠ l√Ω</h6>
                  <h3 class="text-bold mb-10" id="pendingStat">0</h3>
                  <p class="text-sm text-warning">
                    <i class="lni lni-alarm"></i> Pending
                  </p>
                </div>
              </div>
            </div>
            <div class="col-xl-2 col-lg-4 col-sm-6">
              <div class="icon-card mb-30">
                <div class="icon primary">
                  <i class="lni lni-checkmark-circle"></i>
                </div>
                <div class="content">
                  <h6 class="mb-10">ƒê√£ x√°c nh·∫≠n</h6>
                  <h3 class="text-bold mb-10" id="confirmedStat">0</h3>
                  <p class="text-sm text-info">
                    <i class="lni lni-checkmark"></i> Confirmed
                  </p>
                </div>
              </div>
            </div>
            <div class="col-xl-2 col-lg-4 col-sm-6">
              <div class="icon-card mb-30">
                <div class="icon warning">
                  <i class="lni lni-cog"></i>
                </div>
                <div class="content">
                  <h6 class="mb-10">ƒêang x·ª≠ l√Ω</h6>
                  <h3 class="text-bold mb-10" id="processingStat">0</h3>
                  <p class="text-sm text-secondary">
                    <i class="lni lni-spinner-arrow"></i> Processing
                  </p>
                </div>
              </div>
            </div>
            <div class="col-xl-2 col-lg-4 col-sm-6">
              <div class="icon-card mb-30">
                <div class="icon success">
                  <i class="lni lni-thumbs-up"></i>
                </div>
                <div class="content">
                  <h6 class="mb-10">Ho√†n th√†nh</h6>
                  <h3 class="text-bold mb-10" id="completedStat">0</h3>
                  <p class="text-sm text-success">
                    <i class="lni lni-checkmark"></i> Done
                  </p>
                </div>
              </div>
            </div>
            <div class="col-xl-2 col-lg-4 col-sm-6">
              <div class="icon-card mb-30">
                <div class="icon danger">
                  <i class="lni lni-cross-circle"></i>
                </div>
                <div class="content">
                  <h6 class="mb-10">ƒê√£ h·ªßy</h6>
                  <h3 class="text-bold mb-10" id="cancelledStat">0</h3>
                  <p class="text-sm text-danger">
                    <i class="lni lni-close"></i> Cancelled
                  </p>
                </div>
              </div>
            </div>
          </div>
          <!-- End Row -->

          <!-- ========== Orders Table ========== -->
          <div class="row">
            <div class="col-lg-12">
              <div class="card-style mb-30">
                <div class="title d-flex flex-wrap justify-content-between align-items-center">
                  <div class="left">
                    <h6 class="text-medium mb-30">Danh S√°ch ƒê∆°n H√†ng</h6>
                  </div>
                  <div class="right">
                    <div class="select-style-1">
                      <div class="select-position select-sm">
                        <select class="light-bg" id="statusFilter">
                          <option value="all">T·∫•t c·∫£</option>
                          <option value="pending">Ch·ªù x·ª≠ l√Ω</option>
                          <option value="confirmed">ƒê√£ x√°c nh·∫≠n</option>
                          <option value="processing">ƒêang x·ª≠ l√Ω</option>
                          <option value="completed">Ho√†n th√†nh</option>
                          <option value="cancelled">ƒê√£ h·ªßy</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="table-wrapper table-responsive">
                  <table class="table">
                    <thead>
                      <tr>
                        <th><h6 class="text-sm text-medium">ID</h6></th>
                        <th><h6 class="text-sm text-medium">Kh√°ch h√†ng</h6></th>
                        <th class="min-width"><h6 class="text-sm text-medium">SƒêT</h6></th>
                        <th class="min-width"><h6 class="text-sm text-medium">D·ªãch v·ª•</h6></th>
                        <th class="min-width"><h6 class="text-sm text-medium">Link TikTok</h6></th>
                        <th class="min-width"><h6 class="text-sm text-medium">Tr·∫°ng th√°i</h6></th>
                        <th class="min-width"><h6 class="text-sm text-medium">Th·ªùi gian</h6></th>
                      </tr>
                    </thead>
                    <tbody id="ordersTableBody">
                      <tr>
                        <td colspan="7" class="text-center py-5">ƒêang t·∫£i...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          <!-- End Row -->

        </div>
      </section>
      <!-- ========== section end ========== -->

      <!-- ========== footer start =========== -->
      <footer class="footer">
        <div class="container-fluid">
          <div class="row">
            <div class="col-md-6 order-last order-md-first">
              <div class="copyright text-center text-md-start">
                <p class="text-sm">¬© 2024-2025 TikTok Menu Admin Dashboard</p>
              </div>
            </div>
          </div>
        </div>
      </footer>
      <!-- ========== footer end =========== -->
    </main>
    <!-- ======== main-wrapper end =========== -->

    <!-- PlainAdmin JS -->
    <script src="admin-assets/js/bootstrap.bundle.min.js"></script>
    <script src="admin-assets/js/main.js"></script>

    <!-- Dashboard Logic -->
    <script>
      // Check auth - redirect to login if not authenticated
      if (!localStorage.getItem('adminToken')) {
        window.location.href = 'admin-login.html';
      }

      // State
      let allOrders = [];
      let currentFilter = 'all';

      // DOM Elements
      const logoutBtn = document.getElementById('logoutBtn');
      const logoutBtn2 = document.getElementById('logoutBtn2');
      const ordersTableBody = document.getElementById('ordersTableBody');
      const statusFilter = document.getElementById('statusFilter');
      const searchInput = document.getElementById('searchInput');

      // Logout handlers
      function logout() {
        localStorage.removeItem('adminToken');
        window.location.href = 'admin-login.html';
      }
      logoutBtn.addEventListener('click', (e) => { e.preventDefault(); logout(); });
      logoutBtn2.addEventListener('click', (e) => { e.preventDefault(); logout(); });

      // Filter handler
      statusFilter.addEventListener('change', () => {
        currentFilter = statusFilter.value;
        renderOrders();
      });

      // Search handler
      searchInput.addEventListener('input', () => {
        renderOrders();
      });

      // Load orders
      async function loadOrders() {
        try {
          const response = await fetch('/.netlify/functions/orders');
          allOrders = await response.json();
          updateStats();
          renderOrders();
        } catch (error) {
          console.error('Error loading orders:', error);
          ordersTableBody.innerHTML = `
            <tr>
              <td colspan="7" class="text-center py-5 text-danger">
                ‚ùå Kh√¥ng th·ªÉ t·∫£i ƒë∆°n h√†ng
              </td>
            </tr>
          `;
        }
      }

      // Update stats
      function updateStats() {
        document.getElementById('totalStat').textContent = allOrders.length;
        document.getElementById('pendingStat').textContent = allOrders.filter(o => o.status === 'pending').length;
        document.getElementById('confirmedStat').textContent = allOrders.filter(o => o.status === 'confirmed').length;
        document.getElementById('processingStat').textContent = allOrders.filter(o => o.status === 'processing').length;
        document.getElementById('completedStat').textContent = allOrders.filter(o => o.status === 'completed').length;
        document.getElementById('cancelledStat').textContent = allOrders.filter(o => o.status === 'cancelled').length;
      }

      // Render orders table
      function renderOrders() {
        let filteredOrders = allOrders;
        
        // Filter by status
        if (currentFilter !== 'all') {
          filteredOrders = filteredOrders.filter(o => o.status === currentFilter);
        }

        // Filter by search
        const searchTerm = searchInput.value.toLowerCase();
        if (searchTerm) {
          filteredOrders = filteredOrders.filter(o => 
            o.customer_name.toLowerCase().includes(searchTerm) ||
            o.customer_phone.includes(searchTerm) ||
            o.service_type.toLowerCase().includes(searchTerm)
          );
        }

        if (filteredOrders.length === 0) {
          ordersTableBody.innerHTML = `
            <tr>
              <td colspan="7" class="text-center py-5">
                üì≠ Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o
              </td>
            </tr>
          `;
          return;
        }

        ordersTableBody.innerHTML = filteredOrders.map(order => {
          // Parse TikTok link from note
          let noteHtml = order.note || '-';
          if (order.note && order.note.includes('tiktok.com')) {
            const urlMatch = order.note.match(/(https?:\/\/[^\s]+)/);
            if (urlMatch) {
              noteHtml = `<a href="${urlMatch[0]}" target="_blank" class="text-primary">${urlMatch[0].substring(0, 40)}...</a>`;
            }
          }

          return `
            <tr>
              <td><p class="text-sm"><strong>#${order.id}</strong></p></td>
              <td>
                <div class="employee-image">
                  <p class="text-sm">${order.customer_name}</p>
                </div>
              </td>
              <td><p class="text-sm">${order.customer_phone}</p></td>
              <td>
                <p class="text-sm">
                  <span class="badge bg-${order.service_category === 'free' ? 'success' : 'primary'}">${order.service_category === 'free' ? 'Free' : 'Combo'}</span>
                  <br><small>${order.service_type}</small>
                </p>
              </td>
              <td style="max-width: 200px;"><p class="text-sm">${noteHtml}</p></td>
              <td>
                <select class="form-select form-select-sm" onchange="updateStatus(${order.id}, this.value)" style="min-width: 130px;">
                  <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Ch·ªù x·ª≠ l√Ω</option>
                  <option value="confirmed" ${order.status === 'confirmed' ? 'selected' : ''}>ƒê√£ x√°c nh·∫≠n</option>
                  <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>ƒêang x·ª≠ l√Ω</option>
                  <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>Ho√†n th√†nh</option>
                  <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>ƒê√£ h·ªßy</option>
                </select>
              </td>
              <td><p class="text-sm">${new Date(order.created_at).toLocaleString('vi-VN')}</p></td>
            </tr>
          `;
        }).join('');
      }

      // Update order status
      async function updateStatus(orderId, newStatus) {
        try {
          const token = localStorage.getItem('adminToken');
          const response = await fetch('/.netlify/functions/update-order-status', {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ id: orderId, status: newStatus })
          });

          if (response.ok) {
            const order = allOrders.find(o => o.id === orderId);
            if (order) {
              order.status = newStatus;
            }
            updateStats();
            alert('‚úÖ C·∫≠p nh·∫≠t th√†nh c√¥ng!');
          } else if (response.status === 401) {
            alert('‚ùå Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n! Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
            logout();
          } else {
            alert('‚ùå Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i!');
            loadOrders();
          }
        } catch (error) {
          console.error('Error updating status:', error);
          alert('‚ùå C√≥ l·ªói x·∫£y ra!');
        }
      }

      // Auto refresh every 30 seconds
      setInterval(loadOrders, 30000);

      // Load orders on page load
      loadOrders();
    </script>
  </body>
</html>
